<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>UTMãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ Cookieä¿å­˜ãƒ†ã‚¹ãƒˆãƒšãƒ¼ã‚¸</title>
</head>
<body>

    <h1>UTMãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ Cookieä¿å­˜ãƒ†ã‚¹ãƒˆãƒšãƒ¼ã‚¸</h1>
    <p>ã“ã®ãƒšãƒ¼ã‚¸ã«UTMãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ä»˜ãã®URLã§ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ãã ã•ã„ã€‚</p>
    <p>ä¾‹: <code>https://yourdomain.com/test.html?utm_source=cookie_src&utm_medium=cookie_med</code></p>
    
    <div id="status"></div>
    <div id="stored_values"></div>

    <script>
        // --- Cookieæ“ä½œã®ãŸã‚ã®ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•° ---

        // Cookieã‹ã‚‰ç‰¹å®šã®å€¤ã‚’å–å¾—ã™ã‚‹é–¢æ•°
        function getCookie(name) {
            const nameEQ = name + "=";
            const ca = document.cookie.split(';');
            for(let i = 0; i < ca.length; i++) {
                let c = ca[i];
                while (c.charAt(0) === ' ') c = c.substring(1, c.length);
                if (c.indexOf(nameEQ) === 0) return c.substring(nameEQ.length, c.length);
            }
            return null;
        }

        // Cookieã«å€¤ã‚’è¨­å®šã™ã‚‹é–¢æ•°ï¼ˆæœ‰åŠ¹æœŸé™: 30æ—¥ï¼‰
        function setCookie(name, value, days) {
            let expires = "";
            if (days) {
                const date = new Date();
                date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
                expires = "; expires=" + date.toUTCString();
            }
            document.cookie = name + "=" + (value || "") + expires + "; path=/; secure"; // 'secure'ã¯HTTPSç’°å¢ƒã§ã®ã¿å‹•ä½œ
        }

        // --- UTMãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®å‡¦ç†ãƒ­ã‚¸ãƒƒã‚¯ ---

        const utm_keys = ['utm_source', 'utm_medium', 'utm_campaign', 'utm_term', 'utm_content'];

        function persistUtmParameters() {
            const params = new URLSearchParams(window.location.search);
            let update_message = '<h3>å‡¦ç†çµæœ:</h3>';
            let stored_values = {};

            let new_values_saved = false;

            utm_keys.forEach(key => {
                const url_value = params.get(key);
                const cookie_value = getCookie('initial_' + key);

                if (cookie_value) {
                    // æ—¢ã«Cookieã«å€¤ãŒã‚ã‚‹å ´åˆã¯ä¿æŒ
                    stored_values[key] = cookie_value;
                    update_message += `<p>ã€€- ${key}: <strong>${cookie_value}</strong> (Cookieã«ä¿æŒæ¸ˆã¿)</p>`;
                } else if (url_value) {
                    // Cookieã«å€¤ãŒãªãã€URLã«å€¤ãŒã‚ã‚‹å ´åˆã¯Cookieã«ä¿å­˜
                    setCookie('initial_' + key, url_value, 30); // 30æ—¥é–“æœ‰åŠ¹ãªCookieã¨ã—ã¦è¨­å®š
                    stored_values[key] = url_value;
                    new_values_saved = true;
                    update_message += `<p style="color: green;">ğŸ†• ${key}: <strong>${url_value}</strong> (Cookieã«æ–°è¦ä¿å­˜)</p>`;
                } else {
                    // ã©ã¡ã‚‰ã«ã‚‚å€¤ãŒãªã„
                    stored_values[key] = '(å€¤ãªã—)';
                    update_message += `<p>ã€€- ${key}: (å€¤ãªã—)</p>`;
                }
            });

            if (new_values_saved) {
                update_message = '<h3>å‡¦ç†çµæœ:</h3><p style="color: blue;">âœ… UTMãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’Cookieã«æ–°è¦ä¿å­˜ã—ã¾ã—ãŸã€‚</p>' + update_message.substring(update_message.indexOf('<p>'));
            } else if (getCookie('initial_utm_source')) {
                 update_message = '<h3>å‡¦ç†çµæœ:</h3><p style="color: blue;">âœ… æ—¢å­˜ã®Cookieæƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸã€‚æ–°ã—ã„å€¤ã§ä¸Šæ›¸ãã—ã¾ã›ã‚“ã€‚</p>' + update_message.substring(update_message.indexOf('<p>'));
            } else {
                 update_message = '<h3>å‡¦ç†çµæœ:</h3><p>Cookieã«ã‚‚URLã«ã‚‚UTMæƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚</p>';
            }

            // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤ºã‚’æ›´æ–°
            document.getElementById('status').innerHTML = update_message;
            
            // ç¾åœ¨ä¿å­˜ã•ã‚Œã¦ã„ã‚‹å€¤ã‚’è¡¨ç¤º
            let display_html = '<h3>ç¾åœ¨Cookieã«ä¿å­˜ã•ã‚Œã¦ã„ã‚‹ãƒ‡ãƒ¼ã‚¿:</h3><ul>';
            utm_keys.forEach(key => {
                const cookie_value = getCookie('initial_' + key);
                display_html += `<li>initial_${key}: ${cookie_value ? cookie_value : 'ãƒ‡ãƒ¼ã‚¿ãªã—'}</li>`;
            });
            display_html += '</ul>';

            document.getElementById('stored_values').innerHTML = display_html;
        }

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«å®Ÿè¡Œ
        persistUtmParameters();
    </script>

</body>
</html>
