<!DOCTYPE html>

<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>UTMãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ä¿æŒãƒšãƒ¼ã‚¸</title>
</head>
<body>
    <h1>UTMãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ä¿æŒãƒ†ã‚¹ãƒˆãƒšãƒ¼ã‚¸</h1>
    <p>ã“ã®ãƒšãƒ¼ã‚¸ã«UTMãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ä»˜ãã®URLã§ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ãã ã•ã„ã€‚</p>
    <p>ä¾‹: <code>https://yourdomain.com/test.html?utm_source=google_ad&utm_medium=cpc&utm_campaign=winter_sale</code></p>
    <div id="status"></div>
    <div id="stored_values"></div>
    <script>
        // å–å¾—ãƒ»ä¿æŒã—ãŸã„UTMãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®ãƒªã‚¹ãƒˆ
        const utm_keys = ['utm_source', 'utm_medium', 'utm_campaign', 'utm_term', 'utm_content'];
        /**
         * URLã‹ã‚‰ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã€ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜ã™ã‚‹é–¢æ•°
         * (æ—¢å­˜ã®å€¤ãŒã‚ã‚‹å ´åˆã¯ä¸Šæ›¸ãã—ãªã„)
         */
        function persistUtmParameters() {
            const params = new URLSearchParams(window.location.search);
            let update_message = '<h3>å‡¦ç†çµæœ:</h3>';
            let stored_data = {};
            // 1. ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«æ—¢å­˜ã®UTMæƒ…å ±ãŒã‚ã‚‹ã‹ç¢ºèª
            const stored_utm_json = localStorage.getItem('initial_utm_params');
            if (stored_utm_json) {
                stored_data = JSON.parse(stored_utm_json);
                update_message += '<p style="color: blue;">âœ… æ—¢å­˜ã®UTMæƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸã€‚æ–°ã—ã„å€¤ã§ä¸Šæ›¸ãã—ã¾ã›ã‚“ã€‚</p>';
            } else {
                update_message += '<p style="color: green;">ğŸ†• æ–°ã—ã„UTMæƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸã€‚ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜ã—ã¾ã™ã€‚</p>';
            }
            let new_values_found = false;
            // 2. URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ãƒã‚§ãƒƒã‚¯ã—ã€ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«å­˜åœ¨ã—ãªã„å ´åˆã®ã¿ä¿å­˜
            utm_keys.forEach(key => {
                const url_value = params.get(key);
                // URLã«å€¤ãŒã‚ã‚Šã€ã‹ã¤ã€ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ã¾ã å€¤ãŒãªã„å ´åˆ
                if (url_value && !stored_data[key]) {
                    stored_data[key] = url_value;
                    new_values_found = true;
                } else if (stored_data[key]) {
                    // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«å€¤ãŒã‚ã‚‹å ´åˆï¼ˆURLã«å€¤ãŒã‚ã£ã¦ã‚‚ãªãã¦ã‚‚ï¼‰
                    update_message += `<p>ã€€- ${key}: <strong>${stored_data[key]}</strong> (ä¿æŒ)</p>`;
                } else {
                    // URLã«ã‚‚ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ã‚‚å€¤ãŒãªã„å ´åˆ
                    update_message += `<p>ã€€- ${key}: (å€¤ãªã—)</p>`;
                }
            });
            // 3. æ–°ã—ã„å€¤ãŒæ ¼ç´ã•ã‚ŒãŸå ´åˆã€ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚’æ›´æ–°
            if (new_values_found || !stored_utm_json) {
                localStorage.setItem('initial_utm_params', JSON.stringify(stored_data));
            }  
            // 4. ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤ºã‚’æ›´æ–°
            document.getElementById('status').innerHTML = update_message;

            // 5. ç¾åœ¨ä¿å­˜ã•ã‚Œã¦ã„ã‚‹å€¤ã‚’è¡¨ç¤º
            const current_stored_json = localStorage.getItem('initial_utm_params');
            document.getElementById('stored_values').innerHTML = `
                <h3>ç¾åœ¨ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜ã•ã‚Œã¦ã„ã‚‹ãƒ‡ãƒ¼ã‚¿:</h3>
                <pre>${current_stored_json ? current_stored_json : 'ãƒ‡ãƒ¼ã‚¿ãªã—'}</pre>
            `;
        }

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«å®Ÿè¡Œ
        persistUtmParameters();
    </script>
</body>
</html>
